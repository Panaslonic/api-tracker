# Оптимизация AI анализа

## Проблема

AI анализ (через OpenRouter/Gemini) - это дорогая операция:
- 💰 Стоимость API запросов
- ⏱️ Время выполнения (3-6 секунд)
- 🔋 Потребление ресурсов

## Решение

AI анализ выполняется **только когда действительно есть значимые изменения**.

## Логика оптимизации

### 1. OpenAPI сравнение

```
┌─────────────────────────────────────────────────────────┐
│  Структурное сравнение OpenAPI                          │
│  (быстро, без AI)                                       │
└────────────────────┬────────────────────────────────────┘
                     │
         ┌───────────┴────────────┐
         │                        │
         ▼                        ▼
    Нет изменений          Есть изменения
         │                        │
         │                        ▼
         │              ┌──────────────────┐
         │              │  Категоризация   │
         │              │  (breaking/new/  │
         │              │   modified)      │
         │              └────────┬─────────┘
         │                       │
         │              ┌────────┴─────────┐
         │              │                  │
         │              ▼                  ▼
         │         minor changes    moderate/major
         │              │                  │
         │              │                  ▼
         │              │         ┌─────────────────┐
         │              │         │  AI анализ      │
         │              │         │  (детальное     │
         │              │         │   описание)     │
         │              │         └────────┬────────┘
         │              │                  │
         │              ▼                  ▼
         └──────────────┴──────────────────┘
                        │
                        ▼
                  Результат
```

**Критерии:**
- `minor` - только изменения описаний, примеров → **БЕЗ AI**
- `moderate` - новые/удаленные endpoints → **С AI**
- `major` - breaking changes → **С AI**

### 2. HTML сравнение

```
┌─────────────────────────────────────────────────────────┐
│  Быстрая проверка по хешу                               │
└────────────────────┬────────────────────────────────────┘
                     │
         ┌───────────┴────────────┐
         │                        │
         ▼                        ▼
    Хеш совпадает          Хеш отличается
         │                        │
         │                        ▼
         │              ┌──────────────────┐
         │              │  Текстовое       │
         │              │  сравнение       │
         │              └────────┬─────────┘
         │                       │
         │              ┌────────┴─────────┐
         │              │                  │
         │              ▼                  ▼
         │         Нет изменений    Есть изменения
         │              │                  │
         │              │                  ▼
         │              │         ┌─────────────────┐
         │              │         │  AI анализ      │
         │              │         │  (определение   │
         │              │         │   значимости)   │
         │              │         └────────┬────────┘
         │              │                  │
         │              │         ┌────────┴────────┐
         │              │         │                 │
         │              │         ▼                 ▼
         │              │    Незначительные   Значимые
         │              │         │                 │
         └──────────────┴─────────┴─────────────────┘
                                  │
                                  ▼
                            Результат
```

**Критерии AI:**
- Проверяет: даты, версии, мелкие правки
- Если незначительные → сохраняет снэпшот, **НЕ отправляет уведомления**
- Если значимые → отправляет уведомления

### 3. JSON сравнение

```
┌─────────────────────────────────────────────────────────┐
│  Структурное сравнение JSON                             │
│  (DeepDiff)                                             │
└────────────────────┬────────────────────────────────────┘
                     │
         ┌───────────┴────────────┐
         │                        │
         ▼                        ▼
    Нет изменений          Есть изменения
         │                        │
         │                        ▼
         │              ┌──────────────────┐
         │              │  Простое         │
         │              │  описание        │
         │              │  (БЕЗ AI)        │
         │              └────────┬─────────┘
         │                       │
         └───────────────────────┘
                     │
                     ▼
               Результат
```

**Примечание:** JSON обычно структурированный, AI не нужен.

## Примеры

### Пример 1: Minor изменения в OpenAPI

```python
# Изменения
changes = {
    'modified': [
        'paths./users.get.description'  # Только описание
    ]
}

# Результат
severity = 'minor'
ai_summary = "Незначительные изменения в OpenAPI спецификации (1 элементов)"
# AI НЕ вызывается ✅
```

### Пример 2: Major изменения в OpenAPI

```python
# Изменения
changes = {
    'removed': ['paths./users.delete'],  # Удален endpoint
    'modified': ['paths./users.post.parameters']  # Изменены параметры
}

# Результат
severity = 'major'
# AI вызывается ✅
ai_summary = "Критические изменения: удален endpoint DELETE /users, изменены обязательные параметры POST /users"
```

### Пример 3: Незначительные изменения в HTML

```python
# Изменения в HTML
old_text = "Last updated: 2024-11-19"
new_text = "Last updated: 2024-11-20"

# AI анализ
ai_result = {
    'has_significant_changes': False,  # AI определил как незначительные
    'summary': 'Обновлена только дата',
    'severity': 'minor'
}

# Результат
# Снэпшот сохранен, уведомления НЕ отправлены ✅
```

### Пример 4: Значимые изменения в HTML

```python
# Изменения в HTML
old_text = "POST /api/users - Creates a new user"
new_text = "POST /api/users - Creates a new user. Required: email field"

# AI анализ
ai_result = {
    'has_significant_changes': True,
    'summary': 'Добавлено обязательное поле email',
    'severity': 'moderate'
}

# Результат
# Снэпшот сохранен, уведомления отправлены ✅
```

## Статистика экономии

### Без оптимизации
```
100 проверок → 100 AI запросов
Стоимость: ~$0.30 (Claude 3.5 Sonnet)
Время: ~500 секунд
```

### С оптимизацией
```
100 проверок:
- 70 без изменений → 0 AI запросов
- 20 minor изменений → 0 AI запросов
- 10 moderate/major → 10 AI запросов

Стоимость: ~$0.03 (экономия 90%)
Время: ~50 секунд (экономия 90%)
```

## Конфигурация

### Отключить AI полностью
```bash
# Не настраивайте OPENROUTER_API_KEY и GEMINI_API_KEY
# Система будет работать без AI анализа
```

### Использовать дешевую модель для minor изменений
```python
# В будущем можно добавить
OPENROUTER_MODEL_MINOR=meta-llama/llama-3.1-70b  # Дешевая модель
OPENROUTER_MODEL_MAJOR=anthropic/claude-3.5-sonnet  # Дорогая модель
```

## Логи

### С оптимизацией
```
🔍 Обнаружены изменения в OpenAPI
ℹ️ Незначительные изменения, пропускаем AI анализ
✅ Снэпшот сохранен (без уведомлений)
```

```
🔍 Обнаружены изменения в OpenAPI
🤖 Запускаем AI анализ (severity: major)...
✅ AI анализ завершен
📤 Отправка уведомлений...
```

### Без AI analyzer
```
🔍 Обнаружены изменения в HTML
ℹ️ AI analyzer не настроен, считаем изменения значимыми
✅ Снэпшот сохранен
📤 Отправка уведомлений...
```

## Рекомендации

1. **Настройте AI analyzer** - для фильтрации незначительных изменений
2. **Используйте дешевые модели** - для большинства случаев достаточно Llama 3.1
3. **Мониторьте статистику** - сколько AI запросов делается
4. **Настройте фильтры** - исключите заведомо незначительные изменения

## Будущие улучшения

- [ ] Кэширование AI ответов для похожих изменений
- [ ] Разные модели для разных severity
- [ ] Батчинг AI запросов
- [ ] Локальные LLM модели для minor изменений
- [ ] Статистика использования AI в БД

## Метрики

Добавьте в логи:
```python
logger.info(f"📊 AI запросов за сессию: {ai_requests_count}")
logger.info(f"💰 Примерная стоимость: ${estimated_cost:.4f}")
logger.info(f"⏱️ Время AI анализа: {ai_time:.2f}s")
```

## FAQ

**Q: Можно ли полностью отключить AI?**  
A: Да, просто не настраивайте API ключи. Все изменения будут считаться значимыми.

**Q: Как AI определяет значимость?**  
A: Анализирует контекст: даты, версии, опечатки vs новые параметры, breaking changes.

**Q: Сколько стоит AI анализ?**  
A: Claude 3.5 Sonnet: ~$0.003 за запрос, Llama 3.1: ~$0.0002 за запрос.

**Q: Можно ли использовать локальные модели?**  
A: Пока нет, но планируется добавить поддержку Ollama.

---

**Оптимизация работает! 🎉**

AI анализ вызывается только когда действительно нужен, экономя время и деньги.
